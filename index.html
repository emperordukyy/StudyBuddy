<div id="appCtn" style="min-height:100vh; background:#0f0f0f; color:#e0e0e0; font-family:system-ui, -apple-system, sans-serif; transition:all 0.3s ease;">
  <!-- Header -->
  <header style="padding:1.5rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333;">
    <div style="display:flex; align-items:center; gap:1rem;">
      <h1 style="margin:0; font-size:1.8rem; font-weight:600; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">StudyBuddy</h1>
      <span style="font-size:0.9rem; opacity:0.7;">AI-Powered Learning</span>
    </div>
    <button id="themeToggleBtn" onclick="toggleTheme()" style="background:#1a1a1a; border:1px solid #444; color:#e0e0e0; padding:0.5rem 1rem; border-radius:2rem; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:0.5rem;">
      <span id="themeIcon">üåô</span>
      <span id="themeText">Dark Mode</span>
    </button>
  </header>

  <!-- Main Content -->
  <main style="padding:1.5rem; max-width:1200px; margin:0 auto;">
    <!-- Search Bar -->
    <div style="margin-bottom:2rem;">
      <div style="position:relative; max-width:600px; margin:0 auto;">
        <input id="searchInput" type="text" placeholder="Search flashcard sets..." style="width:100%; padding:1rem 1.5rem; background:#1a1a1a; border:1px solid #333; border-radius:2rem; color:#e0e0e0; font-size:1rem; transition:all 0.2s;">
        <button onclick="performSearch()" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:#667eea; border:none; color:white; padding:0.5rem 1rem; border-radius:1.5rem; cursor:pointer;">Search</button>
      </div>
    </div>

    <!-- View Container -->
    <div id="viewContainer">
      <!-- Library View (Default) -->
      <div id="libraryView">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
          <h2 style="margin:0; font-size:1.5rem;">Flashcard Library</h2>
          <button onclick="showCreateSetView()" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:1.5rem; cursor:pointer; font-weight:500;">+ Create New Set</button>
        </div>
        
        <div id="setsGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:1.5rem;">
          <!-- Sets will be dynamically loaded here -->
        </div>
        
        <div id="loadMoreIndicator" style="text-align:center; padding:2rem; display:none;">
          <div style="display:inline-block; width:40px; height:40px; border:4px solid #333; border-top:4px solid #667eea; border-radius:50%; animation:spin 1s linear infinite;"></div>
        </div>
      </div>

      <!-- Create/Edit Set View -->
      <div id="editSetView" hidden>
        <div style="margin-bottom:1.5rem;">
          <button onclick="showLibraryView()" style="background:none; border:1px solid #444; color:#e0e0e0; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer; margin-right:1rem;">‚Üê Back</button>
          <button onclick="saveCurrentSet()" style="background:#667eea; border:none; color:white; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer;">Save Set</button>
        </div>
        
        <div style="background:#1a1a1a; border-radius:1rem; padding:1.5rem; margin-bottom:1.5rem;">
          <h3 style="margin-top:0; margin-bottom:1rem;">Set Details</h3>
          <input id="setTitleInput" type="text" placeholder="Set Title" style="width:100%; padding:0.8rem; background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0; margin-bottom:1rem;">
          <textarea id="setDescInput" placeholder="Description (optional)" style="width:100%; padding:0.8rem; background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0; min-height:80px; margin-bottom:1rem;"></textarea>
          
          <div style="display:flex; gap:1rem; align-items:center;">
            <button onclick="generateSetCover()" style="background:#764ba2; border:none; color:white; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Generate Cover</button>
            <div id="coverPreview" style="width:60px; height:60px; background:#333; border-radius:0.5rem; display:flex; align-items:center; justify-content:center; color:#888; position:relative; overflow:hidden;">
              <div id="coverLoader" style="position:absolute; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; display:none;">
                <div style="width:30px; height:30px; border:3px solid #333; border-top:3px solid #667eea; border-radius:50%; animation:spin 1s linear infinite;"></div>
              </div>
              <span id="coverText">Cover</span>
            </div>
          </div>
        </div>
        
        <div style="background:#1a1a1a; border-radius:1rem; padding:1.5rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3 style="margin:0;">Flashcards</h3>
            <button onclick="addNewCard()" style="background:#667eea; border:none; color:white; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">+ Add Card</button>
          </div>
          
          <div id="cardsList" style="display:flex; flex-direction:column; gap:1rem;">
            <!-- Cards will be dynamically added here -->
          </div>
        </div>
        
        <div style="margin-top:1.5rem; display:flex; gap:1rem;">
          <button onclick="generateAICards()" style="background:#764ba2; border:none; color:white; padding:0.7rem 1.5rem; border-radius:1rem; cursor:pointer; flex:1;">Generate with AI</button>
          <input id="aiTopicInput" type="text" placeholder="Enter a topic..." style="flex:2; padding:0.7rem; background:#1a1a1a; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0;">
        </div>
      </div>

      <!-- Study View -->
      <div id="studyView" hidden>
        <div style="margin-bottom:1.5rem;">
          <button onclick="showLibraryView()" style="background:none; border:1px solid #444; color:#e0e0e0; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer; margin-right:1rem;">‚Üê Back</button>
          <button onclick="exportProgress()" style="background:#444; border:none; color:#e0e0e0; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer; margin-right:1rem;">Export Progress</button>
          <button onclick="showImportDialog()" style="background:#444; border:none; color:#e0e0e0; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer;">Import Progress</button>
        </div>
        
        <div style="background:#1a1a1a; border-radius:1rem; padding:1.5rem; margin-bottom:1.5rem;">
          <h2 id="studySetTitle" style="margin-top:0; margin-bottom:0.5rem;"></h2>
          <p id="studySetDesc" style="margin:0; opacity:0.7;"></p>
          
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:1rem; margin-top:1.5rem;">
            <button onclick="startStudyMode('flip')" class="modeBtn" style="background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center;">Flip Cards</button>
            <button onclick="startStudyMode('practice')" class="modeBtn" style="background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center;">Practice Mode</button>
            <button onclick="startStudyMode('matching')" class="modeBtn" style="background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center;">Matching Game</button>
            <button onclick="startStudyMode('test')" class="modeBtn" style="background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center;">Test Mode</button>
            <button onclick="startStudyMode('lightning')" class="modeBtn" style="background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center; grid-column:span 2;">‚ö° Lightning Round</button>
            <button onclick="startStudyMode('memory')" class="modeBtn" style="background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center; grid-column:span 2;">üß† Memory Grid</button>
          </div>
        </div>
        
        <div id="studyModeContainer" style="background:#1a1a1a; border-radius:1rem; padding:1.5rem; min-height:400px;">
          <!-- Study mode content will appear here -->
        </div>
      </div>
    </div>
  </main>

  <!-- AI Assistant -->
  <div id="aiAssistantEl" style="position:fixed; bottom:1.5rem; right:1.5rem; width:350px; background:#1a1a1a; border-radius:1rem; border:1px solid #333; box-shadow:0 10px 30px rgba(0,0,0,0.5); transition:all 0.3s ease; transform:translateY(120%);">
    <div style="padding:1rem; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0; display:flex; align-items:center; gap:0.5rem;">
        <span>ü§ñ</span> Study Assistant
      </h3>
      <button onclick="toggleAIAssistant()" style="background:none; border:none; color:#888; cursor:pointer; font-size:1.2rem;">√ó</button>
    </div>
    <div style="padding:1rem; height:300px; overflow-y:auto;">
      <div id="aiChatMessagesEl" style="margin-bottom:1rem;">
        <div style="background:#333; padding:0.8rem; border-radius:0.5rem; margin-bottom:0.8rem;">
          <strong>AI:</strong> Hello! I'm your study assistant. Ask me anything about your current topic or request hints.
        </div>
      </div>
      <div style="display:flex; gap:0.5rem;">
        <input id="aiChatInputEl" type="text" placeholder="Ask a question..." style="flex:1; padding:0.7rem; background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0;">
        <button onclick="sendAIMessage()" style="background:#667eea; border:none; color:white; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Send</button>
      </div>
    </div>
  </div>

  <!-- AI Assistant Toggle Button -->
  <button id="aiAssistantToggleEl" onclick="toggleAIAssistant()" style="position:fixed; bottom:1.5rem; right:1.5rem; width:60px; height:60px; background:#667eea; border:none; color:white; border-radius:50%; cursor:pointer; box-shadow:0 5px 15px rgba(102, 126, 234, 0.4); font-size:1.5rem; display:flex; align-items:center; justify-content:center;">ü§ñ</button>

  <!-- Import Dialog -->
  <div id="importDialog" hidden style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
    <div style="background:#1a1a1a; border-radius:1rem; padding:2rem; max-width:500px; width:90%;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h3 style="margin:0;">Import Your Progress</h3>
        <button onclick="closeImportDialog()" style="background:none; border:none; color:#888; cursor:pointer; font-size:1.2rem;">√ó</button>
      </div>
      <p style="margin-bottom:1.5rem; opacity:0.8;">Paste your save code below to restore your flashcard sets and progress.</p>
      <textarea id="importCodeInput" placeholder="Paste your save code here..." style="width:100%; padding:1rem; background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0; min-height:120px; margin-bottom:1.5rem;"></textarea>
      <div style="display:flex; gap:1rem; justify-content:flex-end;">
        <button onclick="closeImportDialog()" style="background:#444; border:none; color:#e0e0e0; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Cancel</button>
        <button onclick="importProgress()" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Import</button>
      </div>
    </div>
  </div>

  <style>
    /* Global styles */
    body { margin:0; padding:0; }
    
    /* Theme variables */
    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #333;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --accent-primary: #667eea;
      --accent-secondary: #764ba2;
      --border-color: #333;
      --hover-glow: rgba(102, 126, 234, 0.3);
    }
    
    .light-theme {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e9ecef;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --accent-primary: #667eea;
      --accent-secondary: #764ba2;
      --border-color: #dee2e6;
      --hover-glow: rgba(102, 126, 234, 0.2);
    }
    
    /* Apply theme variables */
    #appCtn {
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    header {
      border-bottom: 1px solid var(--border-color);
    }
    
    #themeToggleBtn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    input, textarea {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    .modeBtn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    #aiAssistantEl, #importDialog > div {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
    }
    
    #aiChatMessagesEl > div {
      background: var(--bg-tertiary);
    }
    
    /* Hover effects with glow */
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2), 0 0 15px var(--hover-glow);
      transition: all 0.3s ease;
    }
    
    .card-item:hover {
      transform: scale(1.03);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px var(--hover-glow);
      transition: all 0.3s ease;
    }
    
    .modeBtn:hover {
      background: var(--accent-primary) !important;
      color: white !important;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    /* Card animations */
    .card-item {
      animation: fadeIn 0.5s ease;
      transition: all 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(15px); }
      to { opacity:1; transform:translateY(0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
      100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
    }
    
    /* Flip card styles */
    .flip-card {
      background-color: transparent;
      width: 100%;
      height: 300px;
      perspective: 1000px;
    }
    
    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
    }
    
    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }
    
    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      border-radius:1rem;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1.5rem;
      box-sizing:border-box;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .flip-card-back {
      transform: rotateY(180deg);
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    }
    
    /* Matching game styles */
    .matching-grid {
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:1rem;
    }
    
    .matching-item {
      background: var(--bg-tertiary);
      border:1px solid var(--border-color);
      border-radius:0.5rem;
      padding:1rem;
      cursor:pointer;
      text-align:center;
      transition:all 0.3s ease;
    }
    
    .matching-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      background: var(--accent-primary);
      color: white;
    }
    
    .matching-item.selected {
      background: var(--accent-primary);
      border-color: var(--accent-secondary);
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .matching-item.matched {
      background: #28a745;
      border-color: #1e7e34;
      cursor:default;
      animation: none;
    }
    
    /* Lightning round styles */
    .lightning-container {
      text-align: center;
    }
    
    .lightning-timer {
      font-size: 3rem;
      font-weight: bold;
      margin: 1rem 0;
      color: var(--accent-primary);
      text-shadow: 0 0 10px var(--hover-glow);
    }
    
    .lightning-question {
      background: var(--bg-tertiary);
      border-radius: 1rem;
      padding: 2rem;
      margin: 1.5rem 0;
      font-size: 1.5rem;
    }
    
    .lightning-score {
      font-size: 1.5rem;
      margin: 1rem 0;
    }
    
    .lightning-input {
      width: 100%;
      padding: 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      color: var(--text-primary);
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    
    /* Memory grid styles */
    .memory-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .memory-card {
      aspect-ratio: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .memory-card:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .memory-card.flipped {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      transform: rotateY(180deg);
    }
    
    .memory-card.matched {
      background: #28a745;
      color: white;
      cursor: default;
      animation: pulse 1s;
    }
    
    .memory-card-content {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      backface-visibility: hidden;
      transition: transform 0.6s;
    }
    
    .memory-card-front {
      transform: rotateY(0deg);
    }
    
    .memory-card-back {
      transform: rotateY(180deg);
    }
    
    .memory-card.flipped .memory-card-front {
      transform: rotateY(180deg);
    }
    
    .memory-card.flipped .memory-card-back {
      transform: rotateY(0deg);
    }
    
    /* Celebration animation */
    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--accent-primary);
      animation: confetti-fall 3s linear forwards;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
  </style>

  <script>
    // App state
    let state = {
      theme: 'dark',
      currentView: 'library',
      currentSet: null,
      userSets: [],
      librarySets: [],
      studyMode: null,
      studyProgress: {},
      aiChatHistory: [],
      displayedSets: 9,
      setsPerLoad: 9
    };

    // Initialize app
    function initApp() {
      // Load saved data
      loadUserData();
      
      // Generate library sets
      generateLibrarySets();
      
      // Render initial view
      renderLibraryView();
      
      // Set theme
      applyTheme(state.theme);
      
      // Setup infinite scroll
      setupInfiniteScroll();
    }

    // Theme management
    function toggleTheme() {
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      applyTheme(state.theme);
      localStorage.theme = state.theme;
      
      // Add theme transition animation
      appCtn.style.transition = 'all 0.5s ease';
      setTimeout(() => {
        appCtn.style.transition = 'all 0.3s ease';
      }, 500);
    }

    function applyTheme(theme) {
      if (theme === 'light') {
        appCtn.classList.add('light-theme');
        themeIcon.textContent = '‚òÄÔ∏è';
        themeText.textContent = 'Light Mode';
      } else {
        appCtn.classList.remove('light-theme');
        themeIcon.textContent = 'üåô';
        themeText.textContent = 'Dark Mode';
      }
    }

    // Load user data
    function loadUserData() {
      // Load theme preference
      if (localStorage.theme) {
        state.theme = localStorage.theme;
      }
      
      // Load user sets
      if (localStorage.userSets) {
        try {
          state.userSets = JSON.parse(localStorage.userSets);
        } catch (e) {
          console.error('Failed to parse user sets', e);
        }
      }
      
      // Load study progress
      if (localStorage.studyProgress) {
        try {
          state.studyProgress = JSON.parse(localStorage.studyProgress);
        } catch (e) {
          console.error('Failed to parse study progress', e);
        }
      }
    }

    // Save user data
    function saveUserData() {
      localStorage.userSets = JSON.stringify(state.userSets);
      localStorage.studyProgress = JSON.stringify(state.studyProgress);
    }

    // Generate library sets
    function generateLibrarySets() {
      const topics = [
        { title: 'World Capitals', description: 'Capitals of countries around the world', cards: [
          { front: 'France', back: 'Paris' },
          { front: 'Japan', back: 'Tokyo' },
          { front: 'Brazil', back: 'Bras√≠lia' },
          { front: 'Australia', back: 'Canberra' },
          { front: 'Egypt', back: 'Cairo' }
        ]},
        { title: 'Essential Math Formulas', description: 'Key formulas for algebra and geometry', cards: [
          { front: 'Area of a circle', back: 'A = œÄr¬≤' },
          { front: 'Pythagorean theorem', back: 'a¬≤ + b¬≤ = c¬≤' },
          { front: 'Quadratic formula', back: 'x = [-b ¬± ‚àö(b¬≤ - 4ac)] / 2a' },
          { front: 'Slope formula', back: 'm = (y‚ÇÇ - y‚ÇÅ) / (x‚ÇÇ - x‚ÇÅ)' },
          { front: 'Distance formula', back: 'd = ‚àö[(x‚ÇÇ - x‚ÇÅ)¬≤ + (y‚ÇÇ - y‚ÇÅ)¬≤]' }
        ]},
        { title: 'Famous Historical Events', description: 'Major events that shaped world history', cards: [
          { front: 'World War II', back: '1939-1945' },
          { front: 'French Revolution', back: '1789-1799' },
          { front: 'Renaissance', back: '14th-17th century' },
          { front: 'Industrial Revolution', back: '1760-1840' },
          { front: 'Fall of the Berlin Wall', back: '1989' }
        ]},
        { title: 'Human Anatomy', description: 'Major systems and organs of the human body', cards: [
          { front: 'Largest organ', back: 'Skin' },
          { front: 'Longest bone', back: 'Femur' },
          { front: 'Blood pumping organ', back: 'Heart' },
          { front: 'Oxygen exchange organ', back: 'Lungs' },
          { front: 'Control center of the body', back: 'Brain' }
        ]},
        { title: 'Spanish Vocabulary', description: 'Common Spanish words and phrases', cards: [
          { front: 'Hello', back: 'Hola' },
          { front: 'Thank you', back: 'Gracias' },
          { front: 'Goodbye', back: 'Adi√≥s' },
          { front: 'Please', back: 'Por favor' },
          { front: 'Excuse me', back: 'Perd√≥n' }
        ]},
        { title: 'Key Science Facts', description: 'Fundamental concepts in physics and chemistry', cards: [
          { front: 'Speed of light', back: '299,792,458 m/s' },
          { front: 'Water chemical formula', back: 'H‚ÇÇO' },
          { front: 'Absolute zero', back: '-273.15¬∞C or 0 Kelvin' },
          { front: 'Most abundant gas in atmosphere', back: 'Nitrogen (78%)' },
          { front: 'Smallest particle of matter', back: 'Atom' }
        ]},
        { title: 'Programming Concepts', description: 'Fundamental programming principles', cards: [
          { front: 'Variable', back: 'A named storage location in memory' },
          { front: 'Function', back: 'A reusable block of code' },
          { front: 'Loop', back: 'A control structure for repetition' },
          { front: 'Array', back: 'A collection of elements' },
          { front: 'Object', back: 'A collection of properties and methods' }
        ]},
        { title: 'Art History', description: 'Major art movements and artists', cards: [
          { front: 'Renaissance', back: '14th-17th century cultural movement' },
          { front: 'Impressionism', back: '19th century art movement' },
          { front: 'Cubism', back: 'Early 20th century art movement' },
          { front: 'Surrealism', back: '20th century cultural movement' },
          { front: 'Pop Art', back: 'Mid-20th century art movement' }
        ]},
        { title: 'Geography Basics', description: 'Fundamental geography concepts', cards: [
          { front: 'Continent', back: 'One of Earth\'s seven main landmasses' },
          { front: 'Equator', back: 'Imaginary line around Earth\'s middle' },
          { front: 'Hemisphere', back: 'Half of the Earth' },
          { front: 'Latitude', back: 'Distance north or south from equator' },
          { front: 'Longitude', back: 'Distance east or west from prime meridian' }
        ]},
        { title: 'Literary Devices', description: 'Techniques used in literature', cards: [
          { front: 'Metaphor', back: 'Direct comparison between two things' },
          { front: 'Simile', back: 'Comparison using "like" or "as"' },
          { front: 'Alliteration', back: 'Repetition of initial consonant sounds' },
          { front: 'Personification', back: 'Giving human traits to non-human things' },
          { front: 'Hyperbole', back: 'Extreme exaggeration for effect' }
        ]},
        { title: 'Music Theory', description: 'Fundamental concepts in music', cards: [
          { front: 'Scale', back: 'Sequence of notes in order' },
          { front: 'Chord', back: 'Three or more notes played together' },
          { front: 'Tempo', back: 'Speed of the music' },
          { front: 'Dynamics', back: 'Volume of the music' },
          { front: 'Melody', back: 'Sequence of single notes' }
        ]},
        { title: 'Psychology Basics', description: 'Fundamental psychology concepts', cards: [
          { front: 'Cognition', back: 'Mental processes of understanding' },
          { front: 'Behaviorism', back: 'Study of observable behavior' },
          { front: 'Memory', back: 'Process of storing information' },
          { front: 'Perception', back: 'Interpretation of sensory information' },
          { front: 'Emotion', back: 'Complex psychological state' }
        ]}
      ];
      
      state.librarySets = topics.map((set, index) => ({
        id: `lib-${index}`,
        title: set.title,
        description: set.description,
        cards: set.cards,
        cover: `https://placehold.co/300x200/333/fff?text=${encodeURIComponent(set.title.substring(0, 10))}`,
        isLibrary: true
      }));
    }

    // Setup infinite scroll
    function setupInfiniteScroll() {
      window.addEventListener('scroll', () => {
        if (state.currentView !== 'library') return;
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        
        if (scrollTop + clientHeight >= scrollHeight - 100) {
          loadMoreSets();
        }
      });
    }

    // Load more sets
    function loadMoreSets() {
      const allSets = [...state.userSets, ...state.librarySets];
      if (state.displayedSets >= allSets.length) return;
      
      loadMoreIndicator.style.display = 'block';
      
      // Simulate loading delay
      setTimeout(() => {
        state.displayedSets += state.setsPerLoad;
        renderLibraryView();
        loadMoreIndicator.style.display = 'none';
      }, 800);
    }

    // View management
    function showLibraryView() {
      state.currentView = 'library';
      libraryView.hidden = false;
      editSetView.hidden = true;
      studyView.hidden = true;
      
      // Add fade-in animation
      libraryView.style.opacity = '0';
      setTimeout(() => {
        libraryView.style.transition = 'opacity 0.5s ease';
        libraryView.style.opacity = '1';
      }, 10);
      
      renderLibraryView();
    }

    function showCreateSetView() {
      state.currentView = 'edit';
      state.currentSet = {
        id: `user-${Date.now()}`,
        title: '',
        description: '',
        cards: [],
        cover: null
      };
      
      libraryView.hidden = true;
      editSetView.hidden = false;
      studyView.hidden = true;
      
      // Add fade-in animation
      editSetView.style.opacity = '0';
      setTimeout(() => {
        editSetView.style.transition = 'opacity 0.5s ease';
        editSetView.style.opacity = '1';
      }, 10);
      
      renderEditSetView();
    }

    function showStudyView(setId) {
      const set = [...state.userSets, ...state.librarySets].find(s => s.id === setId);
      if (!set) return;
      
      state.currentView = 'study';
      state.currentSet = set;
      
      libraryView.hidden = true;
      editSetView.hidden = true;
      studyView.hidden = false;
      
      // Add fade-in animation
      studyView.style.opacity = '0';
      setTimeout(() => {
        studyView.style.transition = 'opacity 0.5s ease';
        studyView.style.opacity = '1';
      }, 10);
      
      studySetTitle.textContent = set.title;
      studySetDesc.textContent = set.description;
      
      // Reset study mode container
      studyModeContainer.innerHTML = '<div style="text-align:center; padding:3rem; opacity:0.7;">Select a study mode to begin learning</div>';
    }

    // Render library view
    function renderLibraryView() {
      const allSets = [...state.userSets, ...state.librarySets];
      const setsToShow = allSets.slice(0, state.displayedSets);
      setsGrid.innerHTML = '';
      
      setsToShow.forEach(set => {
        const progress = state.studyProgress[set.id] || { mastered: 0, total: set.cards.length };
        const progressPercent = progress.total > 0 ? Math.round((progress.mastered / progress.total) * 100) : 0;
        
        const setEl = document.createElement('div');
        setEl.className = 'card-item';
        setEl.style.cssText = 'background:var(--bg-secondary); border-radius:1rem; overflow:hidden; border:1px solid var(--border-color); cursor:pointer;';
        setEl.innerHTML = `
          <div style="height:150px; background-image:url(${set.cover || 'https://placehold.co/300x200/333/fff?text=Flashcards'}); background-size:cover; background-position:center;"></div>
          <div style="padding:1.2rem;">
            <h3 style="margin:0 0 0.5rem 0; font-size:1.2rem;">${set.title}</h3>
            <p style="margin:0 0 1rem 0; opacity:0.7; font-size:0.9rem;">${set.description}</p>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-size:0.9rem; opacity:0.7;">${progress.mastered}/${progress.total} mastered</span>
              <div style="width:100px; height:8px; background:var(--bg-tertiary); border-radius:4px; overflow:hidden;">
                <div style="width:${progressPercent}%; height:100%; background:linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
              </div>
            </div>
          </div>
        `;
        
        setEl.onclick = () => showStudyView(set.id);
        setsGrid.appendChild(setEl);
      });
      
      // Show/hide load more indicator
      if (state.displayedSets < allSets.length) {
        loadMoreIndicator.style.display = 'block';
      } else {
        loadMoreIndicator.style.display = 'none';
      }
    }

    // Render edit set view
    function renderEditSetView() {
      setTitleInput.value = state.currentSet.title || '';
      setDescInput.value = state.currentSet.description || '';
      
      if (state.currentSet.cover) {
        coverPreview.innerHTML = `<img src="${state.currentSet.cover}" style="width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">`;
        coverText.style.display = 'none';
      } else {
        coverPreview.innerHTML = '';
        coverText.style.display = 'flex';
      }
      
      renderCardsList();
    }

    // Render cards list
    function renderCardsList() {
      cardsList.innerHTML = '';
      
      if (state.currentSet.cards.length === 0) {
        cardsList.innerHTML = '<div style="text-align:center; padding:2rem; opacity:0.7;">No cards yet. Add some to get started!</div>';
        return;
      }
      
      state.currentSet.cards.forEach((card, index) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card-item';
        cardEl.style.cssText = 'background:var(--bg-primary); border:1px solid var(--border-color); border-radius:0.5rem; padding:1rem;';
        cardEl.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:0.8rem;">
            <span style="font-weight:500;">Card ${index + 1}</span>
            <div>
              <button onclick="moveCard(${index}, -1)" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; margin-right:0.5rem;">‚Üë</button>
              <button onclick="moveCard(${index}, 1)" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; margin-right:0.5rem;">‚Üì</button>
              <button onclick="deleteCard(${index})" style="background:none; border:none; color:#e74c3c; cursor:pointer;">√ó</button>
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
            <div>
              <label style="display:block; margin-bottom:0.3rem; font-size:0.9rem; opacity:0.7;">Front</label>
              <textarea onchange="updateCard(${index}, 'front', this.value)" style="width:100%; padding:0.5rem; background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:0.3rem; color:var(--text-primary); min-height:80px;">${card.front}</textarea>
            </div>
            <div>
              <label style="display:block; margin-bottom:0.3rem; font-size:0.9rem; opacity:0.7;">Back</label>
              <textarea onchange="updateCard(${index}, 'back', this.value)" style="width:100%; padding:0.5rem; background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:0.3rem; color:var(--text-primary); min-height:80px;">${card.back}</textarea>
            </div>
          </div>
        `;
        cardsList.appendChild(cardEl);
      });
    }

    // Card management
    function addNewCard() {
      state.currentSet.cards.push({ front: '', back: '' });
      renderCardsList();
    }

    function updateCard(index, field, value) {
      state.currentSet.cards[index][field] = value;
    }

    function deleteCard(index) {
      state.currentSet.cards.splice(index, 1);
      renderCardsList();
    }

    function moveCard(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= state.currentSet.cards.length) return;
      
      [state.currentSet.cards[index], state.currentSet.cards[newIndex]] = 
      [state.currentSet.cards[newIndex], state.currentSet.cards[index]];
      
      renderCardsList();
    }

    // Save current set
    function saveCurrentSet() {
      state.currentSet.title = setTitleInput.value.trim();
      state.currentSet.description = setDescInput.value.trim();
      
      if (!state.currentSet.title) {
        alert('Please enter a title for your set');
        return;
      }
      
      // Check if this is a new set or editing existing
      const existingIndex = state.userSets.findIndex(s => s.id === state.currentSet.id);
      if (existingIndex >= 0) {
        state.userSets[existingIndex] = state.currentSet;
      } else {
        state.userSets.push(state.currentSet);
      }
      
      saveUserData();
      showLibraryView();
    }

    // Generate set cover with AI
    async function generateSetCover() {
      if (!state.currentSet.title) {
        alert('Please enter a title first');
        return;
      }
      
      try {
        // Show loading animation
        coverLoader.style.display = 'flex';
        coverText.style.display = 'none';
        
        const prompt = `A modern, minimalist illustration representing "${state.currentSet.title}" for educational flashcards, flat design, vibrant colors`;
        const dataUrl = await root.generateImage(prompt);
        state.currentSet.cover = dataUrl;
        
        // Hide loader and show image
        coverLoader.style.display = 'none';
        coverPreview.innerHTML = `<img src="${dataUrl}" style="width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">`;
      } catch (error) {
        console.error('Error generating image:', error);
        coverLoader.style.display = 'none';
        coverText.style.display = 'flex';
        coverText.textContent = 'Error';
      }
    }

    // Generate cards with AI
    async function generateAICards() {
      const topic = aiTopicInput.value.trim();
      if (!topic) {
        alert('Please enter a topic');
        return;
      }
      
      try {
        aiTopicInput.disabled = true;
        const prompt = `Generate 5 question-answer pairs about "${topic}" for educational flashcards. Format as JSON array with "front" and "back" properties.`;
        const response = await root.generateText(prompt);
        
        try {
          const cards = JSON.parse(response);
          if (Array.isArray(cards) && cards.length > 0) {
            state.currentSet.cards = [...state.currentSet.cards, ...cards];
            renderCardsList();
            aiTopicInput.value = '';
          } else {
            throw new Error('Invalid response format');
          }
        } catch (parseError) {
          console.error('Error parsing AI response:', parseError);
          alert('Failed to parse AI response. Please try again.');
        }
      } catch (error) {
        console.error('Error generating cards:', error);
        alert('Failed to generate cards. Please try again.');
      } finally {
        aiTopicInput.disabled = false;
      }
    }

    // Study modes
    function startStudyMode(mode) {
      state.studyMode = mode;
      const set = state.currentSet;
      
      if (set.cards.length === 0) {
        alert('This set has no cards to study');
        return;
      }
      
      // Add mode transition animation
      studyModeContainer.style.opacity = '0';
      setTimeout(() => {
        studyModeContainer.style.transition = 'opacity 0.5s ease';
        studyModeContainer.style.opacity = '1';
        
        switch (mode) {
          case 'flip':
            renderFlipMode();
            break;
          case 'practice':
            renderPracticeMode();
            break;
          case 'matching':
            renderMatchingMode();
            break;
          case 'test':
            renderTestMode();
            break;
          case 'lightning':
            renderLightningMode();
            break;
          case 'memory':
            renderMemoryMode();
            break;
        }
      }, 300);
    }

    // Flip mode
    function renderFlipMode() {
      const set = state.currentSet;
      let currentIndex = 0;
      
      function renderCard() {
        const card = set.cards[currentIndex];
        studyModeContainer.innerHTML = `
          <div class="flip-card" id="flipCardEl">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <h3 style="margin:0;">${card.front}</h3>
              </div>
              <div class="flip-card-back">
                <h3 style="margin:0;">${card.back}</h3>
              </div>
            </div>
          </div>
          <div style="margin-top:2rem; display:flex; justify-content:space-between;">
            <button onclick="previousCard()" style="background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-primary); padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Previous</button>
            <button onclick="flipCard()" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Flip Card</button>
            <button onclick="nextCard()" style="background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-primary); padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Next</button>
          </div>
          <div style="margin-top:1rem; text-align:center; opacity:0.7;">
            Card ${currentIndex + 1} of ${set.cards.length}
          </div>
        `;
      }
      
      window.flipCard = function() {
        const flipCard = flipCardEl;
        flipCard.classList.toggle('flipped');
      };
      
      window.previousCard = function() {
        if (currentIndex > 0) {
          currentIndex--;
          renderCard();
        }
      };
      
      window.nextCard = function() {
        if (currentIndex < set.cards.length - 1) {
          currentIndex++;
          renderCard();
        }
      };
      
      renderCard();
    }

    // Practice mode
    function renderPracticeMode() {
      const set = state.currentSet;
      let currentIndex = 0;
      let score = 0;
      
      function renderCard() {
        const card = set.cards[currentIndex];
        studyModeContainer.innerHTML = `
          <div style="background:var(--bg-tertiary); border-radius:1rem; padding:2rem; margin-bottom:1.5rem;">
            <h3 style="margin-top:0; margin-bottom:1.5rem;">${card.front}</h3>
            <textarea id="practiceAnswer" placeholder="Type your answer here..." style="width:100%; padding:1rem; background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:0.5rem; color:var(--text-primary); min-height:100px; margin-bottom:1rem;"></textarea>
            <div id="feedbackAreaEl" style="margin-bottom:1rem; min-height:30px;"></div>
            <button onclick="checkAnswer()" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Check Answer</button>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>Score: ${score}/${set.cards.length}</div>
            <div>Card ${currentIndex + 1} of ${set.cards.length}</div>
          </div>
        `;
      }
      
      window.checkAnswer = function() {
        const userAnswer = practiceAnswer.value.trim().toLowerCase();
        const correctAnswer = set.cards[currentIndex].back.toLowerCase();
        const feedbackArea = feedbackAreaEl;
        
        if (userAnswer === correctAnswer) {
          feedbackArea.innerHTML = '<div style="color:#2ecc71; font-weight:500;">‚úì Correct!</div>';
          score++;
          
          // Update progress
          if (!state.studyProgress[set.id]) {
            state.studyProgress[set.id] = { mastered: 0, total: set.cards.length };
          }
          state.studyProgress[set.id].mastered = Math.max(state.studyProgress[set.id].mastered, score);
          saveUserData();
          
          setTimeout(() => {
            if (currentIndex < set.cards.length - 1) {
              currentIndex++;
              renderCard();
            } else {
              showResults();
            }
          }, 1500);
        } else {
          feedbackArea.innerHTML = `<div style="color:#e74c3c;">‚úó Incorrect. The answer is: ${set.cards[currentIndex].back}</div>`;
        }
      };
      
      function showResults() {
        studyModeContainer.innerHTML = `
          <div style="text-align:center; padding:2rem;">
            <h2 style="margin-top:0;">Practice Complete!</h2>
            <div style="font-size:3rem; margin:1rem 0;">${score}/${set.cards.length}</div>
            <p style="margin-bottom:2rem;">You got ${score} out of ${set.cards.length} correct.</p>
            <button onclick="startStudyMode('practice')" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer; margin-right:1rem;">Try Again</button>
            <button onclick="showStudyView('${set.id}')" style="background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-primary); padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Back to Set</button>
          </div>
        `;
        
        // Add celebration effect
        if (score === set.cards.length) {
          createCelebration();
        }
      }
      
      renderCard();
    }

    // Matching mode
    function renderMatchingMode() {
      const set = state.currentSet;
      const shuffled = [...set.cards].sort(() => Math.random() - 0.5);
      let selected = [];
      let matched = 0;
      
      studyModeContainer.innerHTML = `
        <div style="margin-bottom:1.5rem;">
          <h3 style="margin-top:0; margin-bottom:0.5rem;">Matching Game</h3>
          <p style="margin:0; opacity:0.7;">Match terms with their definitions</p>
        </div>
        <div class="matching-grid" id="matchingGridEl"></div>
        <div style="margin-top:1.5rem; text-align:center;">
          Matches: ${matched}/${set.cards.length}
        </div>
      `;
      
      const grid = matchingGridEl;
      
      // Create matching items
      const items = [];
      shuffled.forEach((card, index) => {
        items.push({ id: `term-${index}`, text: card.front, type: 'term', pair: `def-${index}` });
        items.push({ id: `def-${index}`, text: card.back, type: 'definition', pair: `term-${index}` });
      });
      
      // Shuffle items
      items.sort(() => Math.random() - 0.5);
      
      // Render items
      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'matching-item';
        itemEl.id = item.id;
        itemEl.textContent = item.text;
        itemEl.dataset.pair = item.pair;
        itemEl.onclick = () => selectItem(item.id);
        grid.appendChild(itemEl);
      });
      
      window.selectItem = function(id) {
        const item = document.getElementById(id);
        if (item.classList.contains('matched') || selected.includes(id)) return;
        
        item.classList.add('selected');
        selected.push(id);
        
        if (selected.length === 2) {
          const first = document.getElementById(selected[0]);
          const second = document.getElementById(selected[1]);
          
          if (first.dataset.pair === second.id && second.dataset.pair === first.id) {
            // Match found
            first.classList.remove('selected');
            second.classList.remove('selected');
            first.classList.add('matched');
            second.classList.add('matched');
            matched++;
            
            // Update progress
            if (!state.studyProgress[set.id]) {
              state.studyProgress[set.id] = { mastered: 0, total: set.cards.length };
            }
            state.studyProgress[set.id].mastered = Math.max(state.studyProgress[set.id].mastered, matched);
            saveUserData();
            
            if (matched === set.cards.length) {
              setTimeout(() => {
                studyModeContainer.innerHTML = `
                  <div style="text-align:center; padding:2rem;">
                    <h2 style="margin-top:0;">Matching Complete!</h2>
                    <p style="margin-bottom:2rem;">You've matched all pairs correctly!</p>
                    <button onclick="startStudyMode('matching')" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer; margin-right:1rem;">Play Again</button>
                    <button onclick="showStudyView('${set.id}')" style="background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-primary); padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Back to Set</button>
                  </div>
                `;
                
                // Add celebration effect
                createCelebration();
              }, 500);
            }
          } else {
            // No match
            setTimeout(() => {
              first.classList.remove('selected');
              second.classList.remove('selected');
            }, 1000);
          }
          
          selected = [];
          
          // Update match counter
          const matchCounter = studyModeContainer.querySelector('div:last-child');
          if (matchCounter) {
            matchCounter.textContent = `Matches: ${matched}/${set.cards.length}`;
          }
        }
      };
    }

    // Test mode
    function renderTestMode() {
      const set = state.currentSet;
      const questions = set.cards.map(card => ({
        question: card.front,
        options: generateOptions(card.back, set.cards),
        correct: card.back
      }));
      
      let currentQuestion = 0;
      let score = 0;
      let answers = [];
      
      function renderQuestion() {
        const q = questions[currentQuestion];
        studyModeContainer.innerHTML = `
          <div style="background:var(--bg-tertiary); border-radius:1rem; padding:2rem; margin-bottom:1.5rem;">
            <h3 style="margin-top:0; margin-bottom:1.5rem;">Question ${currentQuestion + 1} of ${questions.length}</h3>
            <p style="font-size:1.2rem; margin-bottom:1.5rem;">${q.question}</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
              ${q.options.map((option, i) => `
                <button onclick="selectAnswer('${option}')" class="test-option" style="background:var(--bg-secondary); border:1px solid var(--border-color); color:var(--text-primary); padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:left; transition:all 0.2s;">
                  ${String.fromCharCode(65 + i)}. ${option}
                </button>
              `).join('')}
            </div>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <button onclick="previousQuestion()" style="background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-primary); padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Previous</button>
            <button onclick="nextQuestion()" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Next</button>
          </div>
        `;
      }
      
      function generateOptions(correct, allCards) {
        const options = [correct];
        const others = allCards
          .filter(card => card.back !== correct)
          .map(card => card.back)
          .sort(() => Math.random() - 0.5)
          .slice(0, 3);
        
        return [...options, ...others].sort(() => Math.random() - 0.5);
      }
      
      window.selectAnswer = function(answer) {
        answers[currentQuestion] = answer;
        
        // Visual feedback
        document.querySelectorAll('.test-option').forEach(btn => {
          if (btn.textContent.includes(answer)) {
            btn.style.background = 'var(--accent-primary)';
            btn.style.color = 'white';
          } else {
            btn.style.background = 'var(--bg-secondary)';
            btn.style.color = 'var(--text-primary)';
          }
        });
      };
      
      window.previousQuestion = function() {
        if (currentQuestion > 0) {
          currentQuestion--;
          renderQuestion();
          
          // Restore previous answer
          if (answers[currentQuestion]) {
            selectAnswer(answers[currentQuestion]);
          }
        }
      };
      
      window.nextQuestion = function() {
        if (currentQuestion < questions.length - 1) {
          currentQuestion++;
          renderQuestion();
          
          // Restore previous answer
          if (answers[currentQuestion]) {
            selectAnswer(answers[currentQuestion]);
          }
        } else {
          // Calculate score
          score = answers.reduce((acc, answer, i) => {
            return acc + (answer === questions[i].correct ? 1 : 0);
          }, 0);
          
          // Update progress
          if (!state.studyProgress[set.id]) {
            state.studyProgress[set.id] = { mastered: 0, total: set.cards.length };
          }
          state.studyProgress[set.id].mastered = Math.max(state.studyProgress[set.id].mastered, score);
          saveUserData();
          
          // Show results
          studyModeContainer.innerHTML = `
            <div style="text-align:center; padding:2rem;">
              <h2 style="margin-top:0;">Test Complete!</h2>
              <div style="font-size:3rem; margin:1rem 0;">${score}/${questions.length}</div>
              <p style="margin-bottom:2rem;">You got ${score} out of ${questions.length} correct.</p>
              <button onclick="startStudyMode('test')" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer; margin-right:1rem;">Retake Test</button>
              <button onclick="showStudyView('${set.id}')" style="background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-primary); padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Back to Set</button>
            </div>
          `;
          
          // Add celebration effect if perfect score
          if (score === questions.length) {
            createCelebration();
          }
        }
      };
      
      renderQuestion();
    }

    // Lightning round mode
    function renderLightningMode() {
      const set = state.currentSet;
      const timeLimit = 60; // seconds
      let timeLeft = timeLimit;
      let score = 0;
      let currentCardIndex = 0;
      let timerInterval;
      
      function startTimer() {
        timerInterval = setInterval(() => {
          timeLeft--;
          timerEl.textContent = timeLeft;
          
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            endRound();
          }
        }, 1000);
      }
      
      function renderCard() {
        const card = set.cards[currentCardIndex];
        studyModeContainer.innerHTML = `
          <div class="lightning-container">
            <h3 style="margin-top:0; margin-bottom:0.5rem;">‚ö° Lightning Round</h3>
            <p style="margin:0 0 1rem 0; opacity:0.7;">Answer as many questions as you can in ${timeLimit} seconds!</p>
            
            <div class="lightning-timer" id="timerEl">${timeLeft}</div>
            <div class="lightning-score">Score: ${score}</div>
            
            <div class="lightning-question">${card.front}</div>
            
            <input id="lightningAnswer" class="lightning-input" type="text" placeholder="Type your answer..." onkeypress="if(event.key==='Enter') checkLightningAnswer()">
            <button onclick="checkLightningAnswer()" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Submit</button>
          </div>
        `;
        
        // Focus on input
        setTimeout(() => {
          lightningAnswer.focus();
        }, 100);
      }
      
      window.checkLightningAnswer = function() {
        const userAnswer = lightningAnswer.value.trim().toLowerCase();
        const correctAnswer = set.cards[currentCardIndex].back.toLowerCase();
        
        if (userAnswer === correctAnswer) {
          score++;
          currentCardIndex = (currentCardIndex + 1) % set.cards.length;
          renderCard();
        } else {
          // Shake animation for incorrect answer
          lightningAnswer.style.animation = 'shake 0.5s';
          setTimeout(() => {
            lightningAnswer.style.animation = '';
          }, 500);
        }
      };
      
      function endRound() {
        studyModeContainer.innerHTML = `
          <div style="text-align:center; padding:2rem;">
            <h2 style="margin-top:0;">Lightning Round Complete!</h2>
            <div style="font-size:3rem; margin:1rem 0;">${score} points</div>
            <p style="margin-bottom:2rem;">You answered ${score} questions correctly in ${timeLimit} seconds!</p>
            <button onclick="startStudyMode('lightning')" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer; margin-right:1rem;">Play Again</button>
            <button onclick="showStudyView('${set.id}')" style="background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-primary); padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Back to Set</button>
          </div>
        `;
        
        // Add celebration effect
        createCelebration();
      }
      
      // Start the round
      renderCard();
      startTimer();
    }

    // Memory grid mode
    function renderMemoryMode() {
      const set = state.currentSet;
      const gridSize = 4; // 4x4 grid
      const cards = [];
      
      // Create pairs of cards
      for (let i = 0; i < (gridSize * gridSize) / 2; i++) {
        const cardIndex = i % set.cards.length;
        cards.push(set.cards[cardIndex]);
        cards.push(set.cards[cardIndex]);
      }
      
      // Shuffle cards
      cards.sort(() => Math.random() - 0.5);
      
      let flippedCards = [];
      let matchedPairs = 0;
      let moves = 0;
      
      studyModeContainer.innerHTML = `
        <div style="text-align:center; margin-bottom:1.5rem;">
          <h3 style="margin-top:0; margin-bottom:0.5rem;">üß† Memory Grid</h3>
          <p style="margin:0; opacity:0.7;">Match all pairs with the fewest moves!</p>
          <div style="margin-top:1rem; font-size:1.2rem;">Moves: <span id="movesCount">0</span></div>
        </div>
        <div class="memory-grid" id="memoryGridEl"></div>
      `;
      
      const grid = memoryGridEl;
      
      // Render memory cards
      cards.forEach((card, index) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'memory-card';
        cardEl.dataset.index = index;
        cardEl.dataset.pair = card.front;
        cardEl.innerHTML = `
          <div class="memory-card-content memory-card-front">?</div>
          <div class="memory-card-content memory-card-back">${card.front}</div>
        `;
        cardEl.onclick = () => flipCard(index);
        grid.appendChild(cardEl);
      });
      
      window.flipCard = function(index) {
        const card = document.querySelector(`[data-index="${index}"]`);
        
        // Ignore if already flipped or matched
        if (card.classList.contains('flipped') || card.classList.contains('matched')) return;
        
        // Ignore if two cards are already flipped
        if (flippedCards.length >= 2) return;
        
        // Flip the card
        card.classList.add('flipped');
        flippedCards.push(index);
        
        // Check for match when two cards are flipped
        if (flippedCards.length === 2) {
          moves++;
          movesCount.textContent = moves;
          
          const card1 = document.querySelector(`[data-index="${flippedCards[0]}"]`);
          const card2 = document.querySelector(`[data-index="${flippedCards[1]}"]`);
          
          if (card1.dataset.pair === card2.dataset.pair) {
            // Match found
            setTimeout(() => {
              card1.classList.add('matched');
              card2.classList.add('matched');
              flippedCards = [];
              matchedPairs++;
              
              // Check if all pairs are matched
              if (matchedPairs === (gridSize * gridSize) / 2) {
                endMemoryGame();
              }
            }, 500);
          } else {
            // No match
            setTimeout(() => {
              card1.classList.remove('flipped');
              card2.classList.remove('flipped');
              flippedCards = [];
            }, 1000);
          }
        }
      };
      
      function endMemoryGame() {
        studyModeContainer.innerHTML = `
          <div style="text-align:center; padding:2rem;">
            <h2 style="margin-top:0;">Memory Grid Complete!</h2>
            <div style="font-size:3rem; margin:1rem 0;">${moves} moves</div>
            <p style="margin-bottom:2rem;">You matched all pairs in ${moves} moves!</p>
            <button onclick="startStudyMode('memory')" style="background:var(--accent-primary); border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer; margin-right:1rem;">Play Again</button>
            <button onclick="showStudyView('${set.id}')" style="background:var(--bg-tertiary); border:1px solid var(--border-color); color:var(--text-primary); padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Back to Set</button>
          </div>
        `;
        
        // Add celebration effect
        createCelebration();
      }
    }

    // Create celebration effect
    function createCelebration() {
      const celebration = document.createElement('div');
      celebration.className = 'celebration';
      document.body.appendChild(celebration);
      
      // Create confetti
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
        confetti.style.animationDelay = `${Math.random() * 3}s`;
        celebration.appendChild(confetti);
      }
      
      // Remove celebration after animation
      setTimeout(() => {
        celebration.remove();
      }, 3000);
    }

    // Search functionality
    function performSearch() {
      const query = searchInput.value.toLowerCase().trim();
      if (!query) {
        renderLibraryView();
        return;
      }
      
      const allSets = [...state.userSets, ...state.librarySets];
      const filtered = allSets.filter(set => 
        set.title.toLowerCase().includes(query) || 
        set.description.toLowerCase().includes(query)
      );
      
      setsGrid.innerHTML = '';
      
      if (filtered.length === 0) {
        setsGrid.innerHTML = '<div style="text-align:center; padding:3rem; opacity:0.7;">No sets found matching your search.</div>';
        return;
      }
      
      filtered.forEach(set => {
        const progress = state.studyProgress[set.id] || { mastered: 0, total: set.cards.length };
        const progressPercent = progress.total > 0 ? Math.round((progress.mastered / progress.total) * 100) : 0;
        
        const setEl = document.createElement('div');
        setEl.className = 'card-item';
        setEl.style.cssText = 'background:var(--bg-secondary); border-radius:1rem; overflow:hidden; border:1px solid var(--border-color); cursor:pointer;';
        setEl.innerHTML = `
          <div style="height:150px; background-image:url(${set.cover || 'https://placehold.co/300x200/333/fff?text=Flashcards'}); background-size:cover; background-position:center;"></div>
          <div style="padding:1.2rem;">
            <h3 style="margin:0 0 0.5rem 0; font-size:1.2rem;">${set.title}</h3>
            <p style="margin:0 0 1rem 0; opacity:0.7; font-size:0.9rem;">${set.description}</p>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-size:0.9rem; opacity:0.7;">${progress.mastered}/${progress.total} mastered</span>
              <div style="width:100px; height:8px; background:var(--bg-tertiary); border-radius:4px; overflow:hidden;">
                <div style="width:${progressPercent}%; height:100%; background:linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
              </div>
            </div>
          </div>
        `;
        
        setEl.onclick = () => showStudyView(set.id);
        setsGrid.appendChild(setEl);
      });
    }

    // Export/Import functionality
    function exportProgress() {
      const data = {
        userSets: state.userSets,
        studyProgress: state.studyProgress,
        timestamp: new Date().toISOString()
      };
      
      const code = btoa(JSON.stringify(data));
      navigator.clipboard.writeText(code).then(() => {
        alert('Progress code copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy to clipboard. Please copy manually:\n\n' + code);
      });
    }

    function showImportDialog() {
      importDialog.hidden = false;
    }

    function closeImportDialog() {
      importDialog.hidden = true;
      importCodeInput.value = '';
    }

    function importProgress() {
      const code = importCodeInput.value.trim();
      if (!code) {
        alert('Please enter a valid code');
        return;
      }
      
      try {
        const data = JSON.parse(atob(code));
        
        if (data.userSets) {
          state.userSets = data.userSets;
        }
        
        if (data.studyProgress) {
          state.studyProgress = data.studyProgress;
        }
        
        saveUserData();
        closeImportDialog();
        showLibraryView();
        alert('Progress imported successfully!');
      } catch (error) {
        alert('Invalid code. Please check and try again.');
      }
    }

    // AI Assistant
    function toggleAIAssistant() {
      const assistant = aiAssistantEl;
      const toggle = aiAssistantToggleEl;
      
      if (assistant.style.transform === 'translateY(0%)') {
        assistant.style.transform = 'translateY(120%)';
        toggle.style.display = 'flex';
      } else {
        assistant.style.transform = 'translateY(0%)';
        toggle.style.display = 'none';
      }
    }

    function sendAIMessage() {
      const input = aiChatInputEl;
      const message = input.value.trim();
      if (!message) return;
      
      // Add user message
      addAIMessage('You', message);
      input.value = '';
      
      // Simulate AI thinking
      addAIMessage('AI', '...');
      
      // Generate AI response
      setTimeout(async () => {
        try {
          const context = state.currentSet ? `The user is currently studying "${state.currentSet.title}". ` : '';
          const prompt = `${context}The user asked: "${message}". Provide a helpful, educational response.`;
          const response = await root.generateText(prompt);
          
          // Update last message
          const messages = document.querySelectorAll('#aiChatMessagesEl > div');
          const lastMessage = messages[messages.length - 1];
          lastMessage.innerHTML = `<strong>AI:</strong> ${response}`;
        } catch (error) {
          console.error('Error generating AI response:', error);
          const messages = document.querySelectorAll('#aiChatMessagesEl > div');
          const lastMessage = messages[messages.length - 1];
          lastMessage.innerHTML = `<strong>AI:</strong> Sorry, I encountered an error. Please try again.`;
        }
      }, 1000);
    }

    function addAIMessage(sender, message) {
      const messagesContainer = aiChatMessagesEl;
      const messageEl = document.createElement('div');
      messageEl.style.cssText = 'background:var(--bg-tertiary); padding:0.8rem; border-radius:0.5rem; margin-bottom:0.8rem;';
      messageEl.innerHTML = `<strong>${sender}:</strong> ${message}`;
      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Add shake animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
      }
    `;
    document.head.appendChild(style);

    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</div>

    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</div>
