<div id="appCtn" style="min-height:100vh; background:#0f0f0f; color:#e0e0e0; font-family:system-ui, -apple-system, sans-serif; transition:all 0.3s ease;">
  <!-- Header -->
  <header style="padding:1.5rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333;">
    <div style="display:flex; align-items:center; gap:1rem;">
      <h1 style="margin:0; font-size:1.8rem; font-weight:600; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">StudyBuddy</h1>
      <span style="font-size:0.9rem; opacity:0.7;">AI-Powered Learning</span>
    </div>
    <button id="themeToggleBtn" onclick="toggleTheme()" style="background:#1a1a1a; border:1px solid #444; color:#e0e0e0; padding:0.5rem 1rem; border-radius:2rem; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:0.5rem;">
      <span id="themeIcon">üåô</span>
      <span id="themeText">Dark Mode</span>
    </button>
  </header>

  <!-- Main Content -->
  <main style="padding:1.5rem; max-width:1200px; margin:0 auto;">
    <!-- Search Bar -->
    <div style="margin-bottom:2rem;">
      <div style="position:relative; max-width:600px; margin:0 auto;">
        <input id="searchInput" type="text" placeholder="Search flashcard sets..." style="width:100%; padding:1rem 1.5rem; background:#1a1a1a; border:1px solid #333; border-radius:2rem; color:#e0e0e0; font-size:1rem; transition:all 0.2s;">
        <button onclick="performSearch()" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:#667eea; border:none; color:white; padding:0.5rem 1rem; border-radius:1.5rem; cursor:pointer;">Search</button>
      </div>
    </div>

    <!-- View Container -->
    <div id="viewContainer">
      <!-- Library View (Default) -->
      <div id="libraryView">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
          <h2 style="margin:0; font-size:1.5rem;">Flashcard Library</h2>
          <button onclick="showCreateSetView()" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:1.5rem; cursor:pointer; font-weight:500;">+ Create New Set</button>
        </div>
        
        <div id="setsGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:1.5rem;">
          <!-- Sets will be dynamically loaded here -->
        </div>
      </div>

      <!-- Create/Edit Set View -->
      <div id="editSetView" hidden>
        <div style="margin-bottom:1.5rem;">
          <button onclick="showLibraryView()" style="background:none; border:1px solid #444; color:#e0e0e0; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer; margin-right:1rem;">‚Üê Back</button>
          <button onclick="saveCurrentSet()" style="background:#667eea; border:none; color:white; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer;">Save Set</button>
        </div>
        
        <div style="background:#1a1a1a; border-radius:1rem; padding:1.5rem; margin-bottom:1.5rem;">
          <h3 style="margin-top:0; margin-bottom:1rem;">Set Details</h3>
          <input id="setTitleInput" type="text" placeholder="Set Title" style="width:100%; padding:0.8rem; background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0; margin-bottom:1rem;">
          <textarea id="setDescInput" placeholder="Description (optional)" style="width:100%; padding:0.8rem; background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0; min-height:80px; margin-bottom:1rem;"></textarea>
          
          <div style="display:flex; gap:1rem; align-items:center;">
            <button onclick="generateSetCover()" style="background:#764ba2; border:none; color:white; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Generate Cover</button>
            <div id="coverPreview" style="width:60px; height:60px; background:#333; border-radius:0.5rem; display:flex; align-items:center; justify-content:center; color:#888;">Cover</div>
          </div>
        </div>
        
        <div style="background:#1a1a1a; border-radius:1rem; padding:1.5rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3 style="margin:0;">Flashcards</h3>
            <button onclick="addNewCard()" style="background:#667eea; border:none; color:white; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">+ Add Card</button>
          </div>
          
          <div id="cardsList" style="display:flex; flex-direction:column; gap:1rem;">
            <!-- Cards will be dynamically added here -->
          </div>
        </div>
        
        <div style="margin-top:1.5rem; display:flex; gap:1rem;">
          <button onclick="generateAICards()" style="background:#764ba2; border:none; color:white; padding:0.7rem 1.5rem; border-radius:1rem; cursor:pointer; flex:1;">Generate with AI</button>
          <input id="aiTopicInput" type="text" placeholder="Enter a topic..." style="flex:2; padding:0.7rem; background:#1a1a1a; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0;">
        </div>
      </div>

      <!-- Study View -->
      <div id="studyView" hidden>
        <div style="margin-bottom:1.5rem;">
          <button onclick="showLibraryView()" style="background:none; border:1px solid #444; color:#e0e0e0; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer; margin-right:1rem;">‚Üê Back</button>
          <button onclick="exportProgress()" style="background:#444; border:none; color:#e0e0e0; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer; margin-right:1rem;">Export Progress</button>
          <button onclick="showImportDialog()" style="background:#444; border:none; color:#e0e0e0; padding:0.5rem 1rem; border-radius:1rem; cursor:pointer;">Import Progress</button>
        </div>
        
        <div style="background:#1a1a1a; border-radius:1rem; padding:1.5rem; margin-bottom:1.5rem;">
          <h2 id="studySetTitle" style="margin-top:0; margin-bottom:0.5rem;"></h2>
          <p id="studySetDesc" style="margin:0; opacity:0.7;"></p>
          
          <div style="display:flex; gap:1rem; margin-top:1.5rem;">
            <button onclick="startStudyMode('flip')" class="modeBtn" style="flex:1; background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center;">Flip Cards</button>
            <button onclick="startStudyMode('practice')" class="modeBtn" style="flex:1; background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center;">Practice Mode</button>
            <button onclick="startStudyMode('matching')" class="modeBtn" style="flex:1; background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center;">Matching Game</button>
            <button onclick="startStudyMode('test')" class="modeBtn" style="flex:1; background:#333; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:center;">Test Mode</button>
          </div>
        </div>
        
        <div id="studyModeContainer" style="background:#1a1a1a; border-radius:1rem; padding:1.5rem; min-height:400px;">
          <!-- Study mode content will appear here -->
        </div>
      </div>
    </div>
  </main>

  <!-- AI Assistant -->
  <div id="aiAssistantEl" style="position:fixed; bottom:1.5rem; right:1.5rem; width:350px; background:#1a1a1a; border-radius:1rem; border:1px solid #333; box-shadow:0 10px 30px rgba(0,0,0,0.5); transition:all 0.3s ease; transform:translateY(120%);">
    <div style="padding:1rem; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0; display:flex; align-items:center; gap:0.5rem;">
        <span>ü§ñ</span> Study Assistant
      </h3>
      <button onclick="toggleAIAssistant()" style="background:none; border:none; color:#888; cursor:pointer; font-size:1.2rem;">√ó</button>
    </div>
    <div style="padding:1rem; height:300px; overflow-y:auto;">
      <div id="aiChatMessagesEl" style="margin-bottom:1rem;">
        <div style="background:#333; padding:0.8rem; border-radius:0.5rem; margin-bottom:0.8rem;">
          <strong>AI:</strong> Hello! I'm your study assistant. Ask me anything about your current topic or request hints.
        </div>
      </div>
      <div style="display:flex; gap:0.5rem;">
        <input id="aiChatInputEl" type="text" placeholder="Ask a question..." style="flex:1; padding:0.7rem; background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0;">
        <button onclick="sendAIMessage()" style="background:#667eea; border:none; color:white; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Send</button>
      </div>
    </div>
  </div>

  <!-- AI Assistant Toggle Button -->
  <button id="aiAssistantToggleEl" onclick="toggleAIAssistant()" style="position:fixed; bottom:1.5rem; right:1.5rem; width:60px; height:60px; background:#667eea; border:none; color:white; border-radius:50%; cursor:pointer; box-shadow:0 5px 15px rgba(102, 126, 234, 0.4); font-size:1.5rem; display:flex; align-items:center; justify-content:center;">ü§ñ</button>

  <!-- Import Dialog -->
  <div id="importDialog" hidden style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
    <div style="background:#1a1a1a; border-radius:1rem; padding:2rem; max-width:500px; width:90%;">
      <h3 style="margin-top:0; margin-bottom:1rem;">Import Your Progress</h3>
      <p style="margin-bottom:1.5rem; opacity:0.8;">Paste your save code below to restore your flashcard sets and progress.</p>
      <textarea id="importCodeInput" placeholder="Paste your save code here..." style="width:100%; padding:1rem; background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; color:#e0e0e0; min-height:120px; margin-bottom:1.5rem;"></textarea>
      <div style="display:flex; gap:1rem; justify-content:flex-end;">
        <button onclick="closeImportDialog()" style="background:#444; border:none; color:#e0e0e0; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Cancel</button>
        <button onclick="importProgress()" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Import</button>
      </div>
    </div>
  </div>

  <style>
    /* Global styles */
    body { margin:0; padding:0; }
    
    /* Light theme styles */
    .light-theme {
      background:#f8f9fa !important;
      color:#212529 !important;
    }
    .light-theme header {
      border-bottom:1px solid #dee2e6 !important;
    }
    .light-theme #themeToggleBtn {
      background:#e9ecef !important;
      border:1px solid #ced4da !important;
      color:#495057 !important;
    }
    .light-theme input, .light-theme textarea {
      background:#ffffff !important;
      border:1px solid #ced4da !important;
      color:#212529 !important;
    }
    .light-theme .modeBtn {
      background:#e9ecef !important;
      border:1px solid #ced4da !important;
      color:#495057 !important;
    }
    .light-theme #aiAssistant, .light-theme #importDialog > div {
      background:#ffffff !important;
      border:1px solid #dee2e6 !important;
    }
    .light-theme #aiChatMessages > div {
      background:#f1f3f5 !important;
    }
    
    /* Hover effects */
    button:hover {
      transform:translateY(-2px);
      box-shadow:0 5px 15px rgba(0,0,0,0.2);
    }
    .modeBtn:hover {
      background:#444 !important;
    }
    .light-theme .modeBtn:hover {
      background:#dee2e6 !important;
    }
    
    /* Card animations */
    .card-item {
      animation:fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }
    
    /* Flip card styles */
    .flip-card {
      background-color: transparent;
      width: 100%;
      height: 300px;
      perspective: 1000px;
    }
    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }
    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      border-radius:1rem;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1.5rem;
      box-sizing:border-box;
    }
    .flip-card-front {
      background:#333;
      color:#e0e0e0;
    }
    .flip-card-back {
      background:#444;
      color:#e0e0e0;
      transform: rotateY(180deg);
    }
    .light-theme .flip-card-front {
      background:#e9ecef !important;
      color:#212529 !important;
    }
    .light-theme .flip-card-back {
      background:#f8f9fa !important;
      color:#212529 !important;
    }
    
    /* Matching game styles */
    .matching-grid {
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:1rem;
    }
    .matching-item {
      background:#333;
      border:1px solid #444;
      border-radius:0.5rem;
      padding:1rem;
      cursor:pointer;
      text-align:center;
      transition:all 0.2s;
    }
    .matching-item:hover {
      background:#444;
    }
    .matching-item.selected {
      background:#667eea;
      border-color:#764ba2;
    }
    .matching-item.matched {
      background:#28a745;
      border-color:#1e7e34;
      cursor:default;
    }
    .light-theme .matching-item {
      background:#e9ecef !important;
      border:1px solid #ced4da !important;
      color:#212529 !important;
    }
    .light-theme .matching-item:hover {
      background:#f8f9fa !important;
    }
    .light-theme .matching-item.selected {
      background:#cfe2ff !important;
      border-color:#b6d4fe !important;
    }
    .light-theme .matching-item.matched {
      background:#d1e7dd !important;
      border-color:#badbcc !important;
    }
  </style>

  <script>
    // App state
    let state = {
      theme: 'dark',
      currentView: 'library',
      currentSet: null,
      userSets: [],
      librarySets: [],
      studyMode: null,
      studyProgress: {},
      aiChatHistory: []
    };

    // Initialize app
    function initApp() {
      // Load saved data
      loadUserData();
      
      // Generate library sets
      generateLibrarySets();
      
      // Render initial view
      renderLibraryView();
      
      // Set theme
      applyTheme(state.theme);
    }

    // Theme management
    function toggleTheme() {
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      applyTheme(state.theme);
      localStorage.theme = state.theme;
    }

    function applyTheme(theme) {
      if (theme === 'light') {
        appCtn.classList.add('light-theme');
        themeIcon.textContent = '‚òÄÔ∏è';
        themeText.textContent = 'Light Mode';
      } else {
        appCtn.classList.remove('light-theme');
        themeIcon.textContent = 'üåô';
        themeText.textContent = 'Dark Mode';
      }
    }

    // Load user data
    function loadUserData() {
      // Load theme preference
      if (localStorage.theme) {
        state.theme = localStorage.theme;
      }
      
      // Load user sets
      if (localStorage.userSets) {
        try {
          state.userSets = JSON.parse(localStorage.userSets);
        } catch (e) {
          console.error('Failed to parse user sets', e);
        }
      }
      
      // Load study progress
      if (localStorage.studyProgress) {
        try {
          state.studyProgress = JSON.parse(localStorage.studyProgress);
        } catch (e) {
          console.error('Failed to parse study progress', e);
        }
      }
    }

    // Save user data
    function saveUserData() {
      localStorage.userSets = JSON.stringify(state.userSets);
      localStorage.studyProgress = JSON.stringify(state.studyProgress);
    }

    // Generate library sets
    function generateLibrarySets() {
      const topics = [
        { title: 'World Capitals', description: 'Capitals of countries around the world', cards: [
          { front: 'France', back: 'Paris' },
          { front: 'Japan', back: 'Tokyo' },
          { front: 'Brazil', back: 'Bras√≠lia' },
          { front: 'Australia', back: 'Canberra' },
          { front: 'Egypt', back: 'Cairo' }
        ]},
        { title: 'Essential Math Formulas', description: 'Key formulas for algebra and geometry', cards: [
          { front: 'Area of a circle', back: 'A = œÄr¬≤' },
          { front: 'Pythagorean theorem', back: 'a¬≤ + b¬≤ = c¬≤' },
          { front: 'Quadratic formula', back: 'x = [-b ¬± ‚àö(b¬≤ - 4ac)] / 2a' },
          { front: 'Slope formula', back: 'm = (y‚ÇÇ - y‚ÇÅ) / (x‚ÇÇ - x‚ÇÅ)' },
          { front: 'Distance formula', back: 'd = ‚àö[(x‚ÇÇ - x‚ÇÅ)¬≤ + (y‚ÇÇ - y‚ÇÅ)¬≤]' }
        ]},
        { title: 'Famous Historical Events', description: 'Major events that shaped world history', cards: [
          { front: 'World War II', back: '1939-1945' },
          { front: 'French Revolution', back: '1789-1799' },
          { front: 'Renaissance', back: '14th-17th century' },
          { front: 'Industrial Revolution', back: '1760-1840' },
          { front: 'Fall of the Berlin Wall', back: '1989' }
        ]},
        { title: 'Human Anatomy', description: 'Major systems and organs of the human body', cards: [
          { front: 'Largest organ', back: 'Skin' },
          { front: 'Longest bone', back: 'Femur' },
          { front: 'Blood pumping organ', back: 'Heart' },
          { front: 'Oxygen exchange organ', back: 'Lungs' },
          { front: 'Control center of the body', back: 'Brain' }
        ]},
        { title: 'Spanish Vocabulary', description: 'Common Spanish words and phrases', cards: [
          { front: 'Hello', back: 'Hola' },
          { front: 'Thank you', back: 'Gracias' },
          { front: 'Goodbye', back: 'Adi√≥s' },
          { front: 'Please', back: 'Por favor' },
          { front: 'Excuse me', back: 'Perd√≥n' }
        ]},
        { title: 'Key Science Facts', description: 'Fundamental concepts in physics and chemistry', cards: [
          { front: 'Speed of light', back: '299,792,458 m/s' },
          { front: 'Water chemical formula', back: 'H‚ÇÇO' },
          { front: 'Absolute zero', back: '-273.15¬∞C or 0 Kelvin' },
          { front: 'Most abundant gas in atmosphere', back: 'Nitrogen (78%)' },
          { front: 'Smallest particle of matter', back: 'Atom' }
        ]}
      ];
      
      state.librarySets = topics.map((set, index) => ({
        id: `lib-${index}`,
        title: set.title,
        description: set.description,
        cards: set.cards,
        cover: `https://placehold.co/300x200/333/fff?text=${encodeURIComponent(set.title.substring(0, 10))}`,
        isLibrary: true
      }));
    }

    // View management
    function showLibraryView() {
      state.currentView = 'library';
      libraryView.hidden = false;
      editSetView.hidden = true;
      studyView.hidden = true;
      renderLibraryView();
    }

    function showCreateSetView() {
      state.currentView = 'edit';
      state.currentSet = {
        id: `user-${Date.now()}`,
        title: '',
        description: '',
        cards: [],
        cover: null
      };
      
      libraryView.hidden = true;
      editSetView.hidden = false;
      studyView.hidden = true;
      
      renderEditSetView();
    }

    function showStudyView(setId) {
      const set = [...state.userSets, ...state.librarySets].find(s => s.id === setId);
      if (!set) return;
      
      state.currentView = 'study';
      state.currentSet = set;
      
      libraryView.hidden = true;
      editSetView.hidden = true;
      studyView.hidden = false;
      
      studySetTitle.textContent = set.title;
      studySetDesc.textContent = set.description;
      
      // Reset study mode container
      studyModeContainer.innerHTML = '<div style="text-align:center; padding:3rem; opacity:0.7;">Select a study mode to begin learning</div>';
    }

    // Render library view
    function renderLibraryView() {
      const allSets = [...state.userSets, ...state.librarySets];
      setsGrid.innerHTML = '';
      
      allSets.forEach(set => {
        const progress = state.studyProgress[set.id] || { mastered: 0, total: set.cards.length };
        const progressPercent = progress.total > 0 ? Math.round((progress.mastered / progress.total) * 100) : 0;
        
        const setEl = document.createElement('div');
        setEl.className = 'card-item';
        setEl.style.cssText = 'background:#1a1a1a; border-radius:1rem; overflow:hidden; border:1px solid #333; transition:all 0.2s; cursor:pointer;';
        setEl.innerHTML = `
          <div style="height:150px; background-image:url(${set.cover || 'https://placehold.co/300x200/333/fff?text=Flashcards'}); background-size:cover; background-position:center;"></div>
          <div style="padding:1.2rem;">
            <h3 style="margin:0 0 0.5rem 0; font-size:1.2rem;">${set.title}</h3>
            <p style="margin:0 0 1rem 0; opacity:0.7; font-size:0.9rem;">${set.description}</p>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-size:0.9rem; opacity:0.7;">${progress.mastered}/${progress.total} mastered</span>
              <div style="width:100px; height:8px; background:#333; border-radius:4px; overflow:hidden;">
                <div style="width:${progressPercent}%; height:100%; background:linear-gradient(90deg, #667eea, #764ba2);"></div>
              </div>
            </div>
          </div>
        `;
        
        setEl.onclick = () => showStudyView(set.id);
        setsGrid.appendChild(setEl);
      });
    }

    // Render edit set view
    function renderEditSetView() {
      setTitleInput.value = state.currentSet.title || '';
      setDescInput.value = state.currentSet.description || '';
      
      if (state.currentSet.cover) {
        coverPreview.innerHTML = `<img src="${state.currentSet.cover}" style="width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">`;
      } else {
        coverPreview.innerHTML = 'Cover';
      }
      
      renderCardsList();
    }

    // Render cards list
    function renderCardsList() {
      cardsList.innerHTML = '';
      
      if (state.currentSet.cards.length === 0) {
        cardsList.innerHTML = '<div style="text-align:center; padding:2rem; opacity:0.7;">No cards yet. Add some to get started!</div>';
        return;
      }
      
      state.currentSet.cards.forEach((card, index) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card-item';
        cardEl.style.cssText = 'background:#0f0f0f; border:1px solid #333; border-radius:0.5rem; padding:1rem;';
        cardEl.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:0.8rem;">
            <span style="font-weight:500;">Card ${index + 1}</span>
            <div>
              <button onclick="moveCard(${index}, -1)" style="background:none; border:none; color:#888; cursor:pointer; margin-right:0.5rem;">‚Üë</button>
              <button onclick="moveCard(${index}, 1)" style="background:none; border:none; color:#888; cursor:pointer; margin-right:0.5rem;">‚Üì</button>
              <button onclick="deleteCard(${index})" style="background:none; border:none; color:#e74c3c; cursor:pointer;">√ó</button>
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
            <div>
              <label style="display:block; margin-bottom:0.3rem; font-size:0.9rem; opacity:0.7;">Front</label>
              <textarea onchange="updateCard(${index}, 'front', this.value)" style="width:100%; padding:0.5rem; background:#1a1a1a; border:1px solid #333; border-radius:0.3rem; color:#e0e0e0; min-height:80px;">${card.front}</textarea>
            </div>
            <div>
              <label style="display:block; margin-bottom:0.3rem; font-size:0.9rem; opacity:0.7;">Back</label>
              <textarea onchange="updateCard(${index}, 'back', this.value)" style="width:100%; padding:0.5rem; background:#1a1a1a; border:1px solid #333; border-radius:0.3rem; color:#e0e0e0; min-height:80px;">${card.back}</textarea>
            </div>
          </div>
        `;
        cardsList.appendChild(cardEl);
      });
    }

    // Card management
    function addNewCard() {
      state.currentSet.cards.push({ front: '', back: '' });
      renderCardsList();
    }

    function updateCard(index, field, value) {
      state.currentSet.cards[index][field] = value;
    }

    function deleteCard(index) {
      state.currentSet.cards.splice(index, 1);
      renderCardsList();
    }

    function moveCard(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= state.currentSet.cards.length) return;
      
      [state.currentSet.cards[index], state.currentSet.cards[newIndex]] = 
      [state.currentSet.cards[newIndex], state.currentSet.cards[index]];
      
      renderCardsList();
    }

    // Save current set
    function saveCurrentSet() {
      state.currentSet.title = setTitleInput.value.trim();
      state.currentSet.description = setDescInput.value.trim();
      
      if (!state.currentSet.title) {
        alert('Please enter a title for your set');
        return;
      }
      
      // Check if this is a new set or editing existing
      const existingIndex = state.userSets.findIndex(s => s.id === state.currentSet.id);
      if (existingIndex >= 0) {
        state.userSets[existingIndex] = state.currentSet;
      } else {
        state.userSets.push(state.currentSet);
      }
      
      saveUserData();
      showLibraryView();
    }

    // Generate set cover with AI
    async function generateSetCover() {
      if (!state.currentSet.title) {
        alert('Please enter a title first');
        return;
      }
      
      try {
        coverPreview.innerHTML = '‚è≥ Generating...';
        const prompt = `A modern, minimalist illustration representing "${state.currentSet.title}" for educational flashcards, flat design, vibrant colors`;
        const dataUrl = await root.generateImage(prompt);
        state.currentSet.cover = dataUrl;
        coverPreview.innerHTML = `<img src="${dataUrl}" style="width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">`;
      } catch (error) {
        console.error('Error generating image:', error);
        coverPreview.innerHTML = 'Error';
      }
    }

    // Generate cards with AI
    async function generateAICards() {
      const topic = aiTopicInput.value.trim();
      if (!topic) {
        alert('Please enter a topic');
        return;
      }
      
      try {
        aiTopicInput.disabled = true;
        const prompt = `Generate 5 question-answer pairs about "${topic}" for educational flashcards. Format as JSON array with "front" and "back" properties.`;
        const response = await root.generateText(prompt);
        
        try {
          const cards = JSON.parse(response);
          if (Array.isArray(cards) && cards.length > 0) {
            state.currentSet.cards = [...state.currentSet.cards, ...cards];
            renderCardsList();
            aiTopicInput.value = '';
          } else {
            throw new Error('Invalid response format');
          }
        } catch (parseError) {
          console.error('Error parsing AI response:', parseError);
          alert('Failed to parse AI response. Please try again.');
        }
      } catch (error) {
        console.error('Error generating cards:', error);
        alert('Failed to generate cards. Please try again.');
      } finally {
        aiTopicInput.disabled = false;
      }
    }

    // Study modes
    function startStudyMode(mode) {
      state.studyMode = mode;
      const set = state.currentSet;
      
      if (set.cards.length === 0) {
        alert('This set has no cards to study');
        return;
      }
      
      switch (mode) {
        case 'flip':
          renderFlipMode();
          break;
        case 'practice':
          renderPracticeMode();
          break;
        case 'matching':
          renderMatchingMode();
          break;
        case 'test':
          renderTestMode();
          break;
      }
    }

    // Flip mode
    function renderFlipMode() {
      const set = state.currentSet;
      let currentIndex = 0;
      
      function renderCard() {
        const card = set.cards[currentIndex];
        studyModeContainer.innerHTML = `
          <div class="flip-card" id="flipCardEl">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <h3 style="margin:0;">${card.front}</h3>
              </div>
              <div class="flip-card-back">
                <h3 style="margin:0;">${card.back}</h3>
              </div>
            </div>
          </div>
          <div style="margin-top:2rem; display:flex; justify-content:space-between;">
            <button onclick="previousCard()" style="background:#444; border:none; color:#e0e0e0; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Previous</button>
            <button onclick="flipCard()" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Flip Card</button>
            <button onclick="nextCard()" style="background:#444; border:none; color:#e0e0e0; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Next</button>
          </div>
          <div style="margin-top:1rem; text-align:center; opacity:0.7;">
            Card ${currentIndex + 1} of ${set.cards.length}
          </div>
        `;
      }
      
      window.flipCard = function() {
        const flipCard = flipCardEl;
        flipCard.classList.toggle('flipped');
      };
      
      window.previousCard = function() {
        if (currentIndex > 0) {
          currentIndex--;
          renderCard();
        }
      };
      
      window.nextCard = function() {
        if (currentIndex < set.cards.length - 1) {
          currentIndex++;
          renderCard();
        }
      };
      
      renderCard();
    }

    // Practice mode
    function renderPracticeMode() {
      const set = state.currentSet;
      let currentIndex = 0;
      let score = 0;
      
      function renderCard() {
        const card = set.cards[currentIndex];
        studyModeContainer.innerHTML = `
          <div style="background:#333; border-radius:1rem; padding:2rem; margin-bottom:1.5rem;">
            <h3 style="margin-top:0; margin-bottom:1.5rem;">${card.front}</h3>
            <textarea id="practiceAnswer" placeholder="Type your answer here..." style="width:100%; padding:1rem; background:#1a1a1a; border:1px solid #444; border-radius:0.5rem; color:#e0e0e0; min-height:100px; margin-bottom:1rem;"></textarea>
            <div id="feedbackAreaEl" style="margin-bottom:1rem; min-height:30px;"></div>
            <button onclick="checkAnswer()" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Check Answer</button>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>Score: ${score}/${set.cards.length}</div>
            <div>Card ${currentIndex + 1} of ${set.cards.length}</div>
          </div>
        `;
      }
      
      window.checkAnswer = function() {
        const userAnswer = practiceAnswer.value.trim().toLowerCase();
        const correctAnswer = set.cards[currentIndex].back.toLowerCase();
        const feedbackArea = feedbackAreaEl;
        
        if (userAnswer === correctAnswer) {
          feedbackArea.innerHTML = '<div style="color:#2ecc71; font-weight:500;">‚úì Correct!</div>';
          score++;
          
          // Update progress
          if (!state.studyProgress[set.id]) {
            state.studyProgress[set.id] = { mastered: 0, total: set.cards.length };
          }
          state.studyProgress[set.id].mastered = Math.max(state.studyProgress[set.id].mastered, score);
          saveUserData();
          
          setTimeout(() => {
            if (currentIndex < set.cards.length - 1) {
              currentIndex++;
              renderCard();
            } else {
              showResults();
            }
          }, 1500);
        } else {
          feedbackArea.innerHTML = `<div style="color:#e74c3c;">‚úó Incorrect. The answer is: ${set.cards[currentIndex].back}</div>`;
        }
      };
      
      function showResults() {
        studyModeContainer.innerHTML = `
          <div style="text-align:center; padding:2rem;">
            <h2 style="margin-top:0;">Practice Complete!</h2>
            <div style="font-size:3rem; margin:1rem 0;">${score}/${set.cards.length}</div>
            <p style="margin-bottom:2rem;">You got ${score} out of ${set.cards.length} correct.</p>
            <button onclick="startStudyMode('practice')" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer; margin-right:1rem;">Try Again</button>
            <button onclick="showStudyView('${set.id}')" style="background:#444; border:none; color:#e0e0e0; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Back to Set</button>
          </div>
        `;
      }
      
      renderCard();
    }

    // Matching mode
    function renderMatchingMode() {
      const set = state.currentSet;
      const shuffled = [...set.cards].sort(() => Math.random() - 0.5);
      let selected = [];
      let matched = 0;
      
      studyModeContainer.innerHTML = `
        <div style="margin-bottom:1.5rem;">
          <h3 style="margin-top:0; margin-bottom:0.5rem;">Matching Game</h3>
          <p style="margin:0; opacity:0.7;">Match terms with their definitions</p>
        </div>
        <div class="matching-grid" id="matchingGridEl"></div>
        <div style="margin-top:1.5rem; text-align:center;">
          Matches: ${matched}/${set.cards.length}
        </div>
      `;
      
      const grid = matchingGridEl;
      
      // Create matching items
      const items = [];
      shuffled.forEach((card, index) => {
        items.push({ id: `term-${index}`, text: card.front, type: 'term', pair: `def-${index}` });
        items.push({ id: `def-${index}`, text: card.back, type: 'definition', pair: `term-${index}` });
      });
      
      // Shuffle items
      items.sort(() => Math.random() - 0.5);
      
      // Render items
      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'matching-item';
        itemEl.id = item.id;
        itemEl.textContent = item.text;
        itemEl.dataset.pair = item.pair;
        itemEl.onclick = () => selectItem(item.id);
        grid.appendChild(itemEl);
      });
      
      window.selectItem = function(id) {
        const item = document.getElementById(id);
        if (item.classList.contains('matched') || selected.includes(id)) return;
        
        item.classList.add('selected');
        selected.push(id);
        
        if (selected.length === 2) {
          const first = document.getElementById(selected[0]);
          const second = document.getElementById(selected[1]);
          
          if (first.dataset.pair === second.id && second.dataset.pair === first.id) {
            // Match found
            first.classList.remove('selected');
            second.classList.remove('selected');
            first.classList.add('matched');
            second.classList.add('matched');
            matched++;
            
            // Update progress
            if (!state.studyProgress[set.id]) {
              state.studyProgress[set.id] = { mastered: 0, total: set.cards.length };
            }
            state.studyProgress[set.id].mastered = Math.max(state.studyProgress[set.id].mastered, matched);
            saveUserData();
            
            if (matched === set.cards.length) {
              setTimeout(() => {
                studyModeContainer.innerHTML = `
                  <div style="text-align:center; padding:2rem;">
                    <h2 style="margin-top:0;">Matching Complete!</h2>
                    <p style="margin-bottom:2rem;">You've matched all pairs correctly!</p>
                    <button onclick="startStudyMode('matching')" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer; margin-right:1rem;">Play Again</button>
                    <button onclick="showStudyView('${set.id}')" style="background:#444; border:none; color:#e0e0e0; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Back to Set</button>
                  </div>
                `;
              }, 500);
            }
          } else {
            // No match
            setTimeout(() => {
              first.classList.remove('selected');
              second.classList.remove('selected');
            }, 1000);
          }
          
          selected = [];
          
          // Update match counter
          const matchCounter = studyModeContainer.querySelector('div:last-child');
          if (matchCounter) {
            matchCounter.textContent = `Matches: ${matched}/${set.cards.length}`;
          }
        }
      };
    }

    // Test mode
    function renderTestMode() {
      const set = state.currentSet;
      const questions = set.cards.map(card => ({
        question: card.front,
        options: generateOptions(card.back, set.cards),
        correct: card.back
      }));
      
      let currentQuestion = 0;
      let score = 0;
      let answers = [];
      
      function renderQuestion() {
        const q = questions[currentQuestion];
        studyModeContainer.innerHTML = `
          <div style="background:#333; border-radius:1rem; padding:2rem; margin-bottom:1.5rem;">
            <h3 style="margin-top:0; margin-bottom:1.5rem;">Question ${currentQuestion + 1} of ${questions.length}</h3>
            <p style="font-size:1.2rem; margin-bottom:1.5rem;">${q.question}</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
              ${q.options.map((option, i) => `
                <button onclick="selectAnswer('${option}')" class="test-option" style="background:#1a1a1a; border:1px solid #444; color:#e0e0e0; padding:1rem; border-radius:0.5rem; cursor:pointer; text-align:left; transition:all 0.2s;">
                  ${String.fromCharCode(65 + i)}. ${option}
                </button>
              `).join('')}
            </div>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <button onclick="previousQuestion()" style="background:#444; border:none; color:#e0e0e0; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Previous</button>
            <button onclick="nextQuestion()" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Next</button>
          </div>
        `;
      }
      
      function generateOptions(correct, allCards) {
        const options = [correct];
        const others = allCards
          .filter(card => card.back !== correct)
          .map(card => card.back)
          .sort(() => Math.random() - 0.5)
          .slice(0, 3);
        
        return [...options, ...others].sort(() => Math.random() - 0.5);
      }
      
      window.selectAnswer = function(answer) {
        answers[currentQuestion] = answer;
        
        // Visual feedback
        document.querySelectorAll('.test-option').forEach(btn => {
          if (btn.textContent.includes(answer)) {
            btn.style.background = '#667eea';
          } else {
            btn.style.background = '#1a1a1a';
          }
        });
      };
      
      window.previousQuestion = function() {
        if (currentQuestion > 0) {
          currentQuestion--;
          renderQuestion();
          
          // Restore previous answer
          if (answers[currentQuestion]) {
            selectAnswer(answers[currentQuestion]);
          }
        }
      };
      
      window.nextQuestion = function() {
        if (currentQuestion < questions.length - 1) {
          currentQuestion++;
          renderQuestion();
          
          // Restore previous answer
          if (answers[currentQuestion]) {
            selectAnswer(answers[currentQuestion]);
          }
        } else {
          // Calculate score
          score = answers.reduce((acc, answer, i) => {
            return acc + (answer === questions[i].correct ? 1 : 0);
          }, 0);
          
          // Update progress
          if (!state.studyProgress[set.id]) {
            state.studyProgress[set.id] = { mastered: 0, total: set.cards.length };
          }
          state.studyProgress[set.id].mastered = Math.max(state.studyProgress[set.id].mastered, score);
          saveUserData();
          
          // Show results
          studyModeContainer.innerHTML = `
            <div style="text-align:center; padding:2rem;">
              <h2 style="margin-top:0;">Test Complete!</h2>
              <div style="font-size:3rem; margin:1rem 0;">${score}/${questions.length}</div>
              <p style="margin-bottom:2rem;">You got ${score} out of ${questions.length} correct.</p>
              <button onclick="startStudyMode('test')" style="background:#667eea; border:none; color:white; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer; margin-right:1rem;">Retake Test</button>
              <button onclick="showStudyView('${set.id}')" style="background:#444; border:none; color:#e0e0e0; padding:0.7rem 1.5rem; border-radius:0.5rem; cursor:pointer;">Back to Set</button>
            </div>
          `;
        }
      };
      
      renderQuestion();
    }

    // Search functionality
    function performSearch() {
      const query = searchInput.value.toLowerCase().trim();
      if (!query) {
        renderLibraryView();
        return;
      }
      
      const allSets = [...state.userSets, ...state.librarySets];
      const filtered = allSets.filter(set => 
        set.title.toLowerCase().includes(query) || 
        set.description.toLowerCase().includes(query)
      );
      
      setsGrid.innerHTML = '';
      
      if (filtered.length === 0) {
        setsGrid.innerHTML = '<div style="text-align:center; padding:3rem; opacity:0.7;">No sets found matching your search.</div>';
        return;
      }
      
      filtered.forEach(set => {
        const progress = state.studyProgress[set.id] || { mastered: 0, total: set.cards.length };
        const progressPercent = progress.total > 0 ? Math.round((progress.mastered / progress.total) * 100) : 0;
        
        const setEl = document.createElement('div');
        setEl.className = 'card-item';
        setEl.style.cssText = 'background:#1a1a1a; border-radius:1rem; overflow:hidden; border:1px solid #333; transition:all 0.2s; cursor:pointer;';
        setEl.innerHTML = `
          <div style="height:150px; background-image:url(${set.cover || 'https://placehold.co/300x200/333/fff?text=Flashcards'}); background-size:cover; background-position:center;"></div>
          <div style="padding:1.2rem;">
            <h3 style="margin:0 0 0.5rem 0; font-size:1.2rem;">${set.title}</h3>
            <p style="margin:0 0 1rem 0; opacity:0.7; font-size:0.9rem;">${set.description}</p>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-size:0.9rem; opacity:0.7;">${progress.mastered}/${progress.total} mastered</span>
              <div style="width:100px; height:8px; background:#333; border-radius:4px; overflow:hidden;">
                <div style="width:${progressPercent}%; height:100%; background:linear-gradient(90deg, #667eea, #764ba2);"></div>
              </div>
            </div>
          </div>
        `;
        
        setEl.onclick = () => showStudyView(set.id);
        setsGrid.appendChild(setEl);
      });
    }

    // Export/Import functionality
    function exportProgress() {
      const data = {
        userSets: state.userSets,
        studyProgress: state.studyProgress,
        timestamp: new Date().toISOString()
      };
      
      const code = btoa(JSON.stringify(data));
      navigator.clipboard.writeText(code).then(() => {
        alert('Progress code copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy to clipboard. Please copy manually:\n\n' + code);
      });
    }

    function showImportDialog() {
      importDialog.hidden = false;
    }

    function closeImportDialog() {
      importDialog.hidden = true;
      importCodeInput.value = '';
    }

    function importProgress() {
      const code = importCodeInput.value.trim();
      if (!code) {
        alert('Please enter a valid code');
        return;
      }
      
      try {
        const data = JSON.parse(atob(code));
        
        if (data.userSets) {
          state.userSets = data.userSets;
        }
        
        if (data.studyProgress) {
          state.studyProgress = data.studyProgress;
        }
        
        saveUserData();
        closeImportDialog();
        showLibraryView();
        alert('Progress imported successfully!');
      } catch (error) {
        alert('Invalid code. Please check and try again.');
      }
    }

    // AI Assistant
    function toggleAIAssistant() {
      const assistant = aiAssistantEl;
      const toggle = aiAssistantToggleEl;
      
      if (assistant.style.transform === 'translateY(0%)') {
        assistant.style.transform = 'translateY(120%)';
        toggle.style.display = 'flex';
      } else {
        assistant.style.transform = 'translateY(0%)';
        toggle.style.display = 'none';
      }
    }

    function sendAIMessage() {
      const input = aiChatInputEl;
      const message = input.value.trim();
      if (!message) return;
      
      // Add user message
      addAIMessage('You', message);
      input.value = '';
      
      // Simulate AI thinking
      addAIMessage('AI', '...');
      
      // Generate AI response
      setTimeout(async () => {
        try {
          const context = state.currentSet ? `The user is currently studying "${state.currentSet.title}". ` : '';
          const prompt = `${context}The user asked: "${message}". Provide a helpful, educational response.`;
          const response = await root.generateText(prompt);
          
          // Update last message
          const messages = document.querySelectorAll('#aiChatMessages > div');
          const lastMessage = messages[messages.length - 1];
          lastMessage.innerHTML = `<strong>AI:</strong> ${response}`;
        } catch (error) {
          console.error('Error generating AI response:', error);
          const messages = document.querySelectorAll('#aiChatMessages > div');
          const lastMessage = messages[messages.length - 1];
          lastMessage.innerHTML = `<strong>AI:</strong> Sorry, I encountered an error. Please try again.`;
        }
      }, 1000);
    }

    function addAIMessage(sender, message) {
      const messagesContainer = aiChatMessagesEl;
      const messageEl = document.createElement('div');
      messageEl.style.cssText = 'background:#333; padding:0.8rem; border-radius:0.5rem; margin-bottom:0.8rem;';
      messageEl.innerHTML = `<strong>${sender}:</strong> ${message}`;
      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</div>
